<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>EvoShot Test Client</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        #log {
            background: #16213e;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .sent { color: #00d9ff; }
        .received { color: #00ff88; }
        .error { color: #ff6b6b; }
        .info { color: #ffd93d; }
        button {
            background: #4a00e0;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #6a1be0; }
        button:disabled { background: #555; }
        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            margin: 5px;
        }
        #canvas {
            background: #0f0f23;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ® EvoShot Test Client</h1>
    
    <div>
        <input type="text" id="playerName" placeholder="í”Œë ˆì´ì–´ ì´ë¦„" value="TestPlayer">
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
    </div>
    
    <div id="log"></div>
    
    <canvas id="canvas" width="800" height="600"></canvas>

    <script>
        let ws = null;
        let playerId = null;
        let players = {};
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function log(message, type = 'info') {
            const div = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            div.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        function connect() {
            const name = document.getElementById('playerName').value || 'Player';
            ws = new WebSocket('ws://localhost:8080/ws');

            ws.onopen = () => {
                log('WebSocket ì—°ê²°ë¨', 'info');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
                // Connect ë©”ì‹œì§€ ì „ì†¡
                send({ type: 'connect', playerName: name });
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };

            ws.onclose = () => {
                log('WebSocket ì—°ê²° ì¢…ë£Œ', 'error');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                ws = null;
                playerId = null;
            };

            ws.onerror = (error) => {
                log('WebSocket ì—ëŸ¬: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) ws.close();
        }

        function send(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                log('SENT: ' + JSON.stringify(message), 'sent');
            }
        }

        function handleMessage(message) {
            // game_stateëŠ” ë¡œê·¸ ìƒëžµ (60fpsë¡œ ì˜¤ê¸° ë•Œë¬¸)
            if (message.type !== 'game_state') {
                log('RECV: ' + JSON.stringify(message), 'received');
            }

            switch (message.type) {
                case 'connected':
                    playerId = message.playerId;
                    players = {};
                    message.players.forEach(p => players[p.id] = p);
                    log(`ì ‘ì† ì™„ë£Œ! PlayerId: ${playerId}, í˜„ìž¬ ${message.players.length}ëª…`, 'info');
                    break;

                case 'player_join':
                    players[message.player.id] = message.player;
                    log(`${message.player.name} ìž…ìž¥`, 'info');
                    break;

                case 'player_leave':
                    delete players[message.playerId];
                    log(`${message.playerId} í‡´ìž¥`, 'info');
                    break;

                case 'game_state':
                    message.players.forEach(p => players[p.id] = p);
                    break;

                case 'pong':
                    log(`Pong received (latency: ${Date.now() - message.timestamp}ms)`, 'info');
                    break;
            }

            render();
        }

        function render() {
            ctx.fillStyle = '#0f0f23';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            Object.values(players).forEach(player => {
                // í”Œë ˆì´ì–´ ì›
                ctx.beginPath();
                ctx.arc(player.x, player.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = player.id === playerId ? '#00ff88' : '#ff6b6b';
                ctx.fill();

                // ì´ë¦„
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.name, player.x, player.y - 30);
            });
        }

        // ë§ˆìš°ìŠ¤ ì´ë™ ì‹œ ìž…ë ¥ ì „ì†¡ (throttle: 16ms = 60fps)
        let lastMouseX = 0;
        let lastMouseY = 0;
        let lastSendTime = 0;
        const SEND_INTERVAL = 16; // 16ms = ì•½ 60fps

        canvas.addEventListener('mousemove', (e) => {
            if (!ws || !playerId) return;
            
            const rect = canvas.getBoundingClientRect();
            lastMouseX = e.clientX - rect.left;
            lastMouseY = e.clientY - rect.top;

            const now = Date.now();
            if (now - lastSendTime >= SEND_INTERVAL) {
                lastSendTime = now;
                // ë¡œê·¸ ì—†ì´ ì „ì†¡
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'player_input',
                        mouseX: lastMouseX,
                        mouseY: lastMouseY
                    }));
                }
            }
        });

        // Ping í…ŒìŠ¤íŠ¸
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                send({ type: 'ping', timestamp: Date.now() });
            }
        }, 5000);

        render();
    </script>
</body>
</html>

